<!DOCTYPE html>
<html lang="ko" color-theme="light">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>weniv world</title>

    <!-- Favicon -->
    <link rel="shortcut icon" type="image/x-icon" href="./assets/img/icon/icon-logo.svg">

    <!-- í™˜ê²½íŒŒì¼ -->
    <script src="./assets/js/env.js" defer></script>

    <!-- JavaScript -->
    <script src="./assets/js/editor.js" defer></script>
    <script src="./assets/js/parser.js" defer></script>
    <script src="./assets/js/event.js" defer></script>
    <script src="./assets/js/resizer.js" defer></script>

    <!-- PyScript -->
    <link rel="stylesheet" href="assets/pyscript/pyscript.css" />
    <script defer src="assets/pyscript/pyscript_latest.js"></script>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="assets/css/reset.css">
    <link rel="stylesheet" href="assets/css/style.css">

    <py-config>
        terminal = false
        # packages = ["numpy", "nest_asyncio"]

        [[fetch]]
        from = "./assets/py/"
        files = ["built_in_functions.py", "character.py", "map.py", "wall.py", "item.py", "coordinate.py", "modules.py", "error.py"]
    </py-config>
</head>
<body>
    <header class="header">
        <h1>
            <a href="/">
                <span class="sr-only">ìœ„ë‹ˆë¸Œ ì›”ë“œ</span>
                <svg xmlns="http://www.w3.org/2000/svg" width="42" height="42" viewBox="0 0 42 42" fill="none">
                    <rect width="42" height="42" rx="10" fill="#2E6FF2"/>
                    <path d="M32.9063 21C32.3019 21 31.8126 21.4808 31.8126 22.0748C31.8126 24.7075 29.6321 26.8504 26.9532 26.8504C24.2742 26.8504 22.0937 24.7075 22.0937 22.0748C22.0937 21.4808 21.6044 21 21 21C20.3956 21 19.9063 21.4808 19.9063 22.0748C19.9063 24.7075 17.7258 26.8504 15.0468 26.8504C12.3679 26.8504 10.1874 24.7075 10.1874 22.0748C10.1874 21.4808 9.6981 21 9.09369 21C8.48928 21 8 21.4808 8 22.0748C8 25.8932 11.1614 29 15.0468 29C17.5497 29 19.7497 27.7102 21 25.7733C22.2503 27.7102 24.4515 29 26.9532 29C30.8386 29 34 25.8932 34 22.0748C34 21.4808 33.5107 21 32.9063 21Z" fill="white"/>
                    <path d="M15 18C16.1046 18 17 17.1046 17 16C17 14.8954 16.1046 14 15 14C13.8954 14 13 14.8954 13 16C13 17.1046 13.8954 18 15 18Z" fill="white"/>
                    <path d="M27 18C28.1046 18 29 17.1046 29 16C29 14.8954 28.1046 14 27 14C25.8954 14 25 14.8954 25 16C25 17.1046 25.8954 18 27 18Z" fill="white"/>
                  </svg>
            </a>
        </h1>
        <nav class="menu">
            <ul class="menu-list">
                <li>
                    <button type="button" class="button-before btn-story">
                        <span class="sr-only">
                            ìŠ¤í† ë¦¬ ë³´ê¸°
                        </span>
                    </button>
                </li>
                <li>
                    <a href="https://pyalgo.co.kr/codeexec.html" class="basic-btn" target="_blank">ì½”ë“œ ì—ë””í„°ë¡œ ì´ë™</a>
                </li>
                <li>
                    <button type="button" class="btn-dark-mode">
                        <span class="sr-only">ë‹¤í¬ëª¨ë“œ ì˜¨/ì˜¤í”„ ë²„íŠ¼</span>
                    </button>
                </li>
            </ul>
        </nav>
    </header>
    <main class="main">
        <section class="notebook">
            <header class="notebook-header">
                <h2>Notebook</h2>
                <button type="button" class="btn-add-code">ì½”ë“œ ì¶”ê°€</button>
                <ul class="notebook-btn-list">
                    <li>
                        <button type="button" class="downloadNotebookBtn btn-file-export">
                            <span class="sr-only">ë…¸íŠ¸ë¶ ë‚´ë³´ë‚´ê¸°</span>
                        </button>
                    </li>
                    <li>
                        <!-- TODO: ì—…ë¡œë“œ ê¸°ëŠ¥ êµ¬í˜„ -->
                        <button type="button" class="uploadNotebookBtn btn-file-import">
                            <span class="sr-only">ë…¸íŠ¸ë¶ ì¶”ê°€í•˜ê¸°</span>
                        </button>
                    </li>
                </ul>
            </header>
            <section class="notebook-section">
                <h3 class="sr-only">ì½”ë“œ ì…ë ¥</h3>
                <!-- # sample ì½”ë“œì…ë‹ˆë‹¤. shift + enterë¥¼ ëˆŒëŸ¬ ì‹¤í–‰í•´ë³´ì„¸ìš”.
                    # character_data, map_data, item_dataëŠ” ê¸°ë³¸ ì œê³µ ë°ì´í„°ì…ë‹ˆë‹¤.
                    # from modules import turn_rightì™€ ê°™ì´ ëª¨ë“ˆì„ ë¶ˆëŸ¬ì™€ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                    set_item(2, 2, 'fish')
                    move()
                    move()
                    turn_left()
                    turn_left()
                    turn_left()
                    repeat(2, move)
                    # pick() -->
                <py-repl id="my-repl" auto-generate="true">
                    set_item(2, 2, 'fish-1',2)
                    set_item(2, 4, 'fish-2')
                    set_item(4, 2, 'fish-3')
                </py-repl>
            </section>
        </section>
        <div class="resizer" data-direction="horizontal"></div>
        <section class="world">
            <header class="world-header">
                <h2>World</h2>
                <ul class="world-btn-list">
                    <li>
                        <button type="button" class="btn-file-export" id="btn-download-worlddata">
                            <span class="sr-only">ì›”ë“œ ë‚´ë³´ë‚´ê¸°</span>
                        </button>
                    </li>
                    <li>
                        <button type="button" class="btn-file-import" id="btn-upload-worlddata">
                            <span class="sr-only">ì›”ë“œ ì¶”ê°€í•˜ê¸°</span>
                        </button>
                    </li>
                </ul>
            </header>

            <nav class="world-menu">
                <ul class="controll-btn-list">
                    <li>
                        <button class="button-before btn-wall btn-toggle" type="button">
                            <span class="sr-only">ë²½ ë§Œë“¤ê¸°</span>
                        </button>
                        <div class="controller-modal wall-type">
                            <!-- ë²½ì˜ ì¢…ë¥˜ë¥¼ ì •í•  ìˆ˜ ìˆëŠ” label-input -->
                            <div class="input-wrap">
                                <input type="radio" name="wall-type" id="wall" value="wall" checked>
                                <label for="wall">wall(ê¸°ë³¸): orange</label>
                            </div>
                            <div class="input-wrap">
                                <input type="radio" name="wall-type" id="door" value="door">
                                <label for="door">door: sienna</label>
                            </div>
                            <div class="input-wrap">
                                <input type="radio" name="wall-type" id="fence" value="fence">
                                <label for="fence">fence: seagreen</label>
                            </div>
                            <div class="input-wrap">
                                <input type="radio" name="wall-type" id="delete" value="delete">
                                <label for="delete">delete</label>
                            </div>
                        </div>
                    </li>
                    <li>
                        <button class="button-before btn-assets  btn-toggle" type="button">
                            <span class="sr-only">ì•„ì´í…œ ì¶”ê°€í•˜ê¸°</span>
                        </button>
                        <div class="controller-modal select-items">
                            <!-- TODO: items data íŒŒì¼ ë¿Œë ¤ì£¼ê¸° -->
                            <!-- ìš°ì„  fish 3ê°œë§Œ ì¶”ê°€, í˜„ì¬ ë™ì‘ ì•ˆ í•¨ -->
                            <div class="input-wrap">
                                <input type="radio" name="item" id="fish-1" value="fish-1" checked>
                                <label for="item">fish-1(ê¸°ë³¸)</label>
                            </div>
                            <div class="input-wrap">
                                <input type="radio" name="item" id="fish-2" value="fish-2">
                                <label for="item">fish-2</label>
                            </div>
                            <div class="input-wrap">
                                <input type="radio" name="item" id="fish-3" value="fish-3">
                                <label for="item">fish-3</label>
                            </div>
                        </div>
                    </li>
                    <li>
                        <button class="button-before btn-resize btn-toggle" type="button">
                            <span class="sr-only">ì›”ë“œ í¬ê¸° ì¡°ì •í•˜ê¸°</span>
                        </button>
                        <div class="controller-modal resize">
                            <div class="input-wrap">
                                <label for="map-range-x">Map_x</label>
                                <input type="range" min="3" max="10" value="5" class="slider" id="map-range-x">
                                <strong id="map-text-x"></strong>
                            </div>
                            <div class="input-wrap">
                                <label for="map-range-y">Map_y</label>
                                <input type="range" min="3" max="10" value="5" class="slider" id="map-range-y">
                                <strong id="map-text-y"></strong>
                            </div>
                        </div>
                    </li>
                    <li>
                        <button class="button-before btn-speed btn-toggle" type="button">
                            <span class="sr-only">ì†ë„ ì¡°ì ˆí•˜ê¸°</span>
                        </button>
                        <div class="controller-modal speed">
                            <div class="input-wrap">
                                <label for="speed-range">Speed</label>
                                <input type="range" min="1" max="100" value="30" class="slider" id="speed-range">
                                <strong id="speed-text"></strong>
                            </div>
                        </div>
                    </li>
                </ul>
                <ul class="info-btn-list">
                    <li>
                        <button class="button-before btn-function btn-toggle" type="button" id="btn-list-function">
                            <span class="sr-only">í•¨ìˆ˜ ë¦¬ìŠ¤íŠ¸ ë³´ê¸°</span>
                        </button>
                        <section class="controller-modal function-list">
                            <h4 class="title">í•¨ìˆ˜ ë¦¬ìŠ¤íŠ¸</h4>
                            <ul>
                                <li>
                                    <button type="button" class="code-item">print()</button>
                                </li>
                                <li>
                                    <button type="button" class="code-item">directions()</button>
                                </li>
                                <li>
                                    <button type="button" class="code-item">show_item()</button>
                                </li>
                                <li>
                                    <button type="button" class="code-item">set_item()</button>
                                </li>
                                <li>
                                    <button type="button" class="code-item">move()</button>
                                </li>
                                <li>
                                    <button type="button" class="code-item">turn_left()</button>
                                </li>
                                <li>
                                    <button type="button" class="code-item">pick()</button>
                                </li>
                                <li>
                                    <button type="button" class="code-item">put()</button>
                                </li>
                                <li>
                                    <button type="button" class="code-item">repeat()</button>
                                </li>
                                <li><button type="button" class="code-item">(from modules import turn_right) turn_right()</button>
                                </li>
                                <li><button type="button" class="code-item">(from modules import turn_around) turn_around()</button>
                                </li>
                                <li>
                                    <button type="button" class="code-item">(from modules import move_to_wall) move_to_wall()</button>
                                </li>
                                <li>
                                    <button type="button" class="code-item">(from modules import turn_left_until_clear) <wbr />turn_left_until_clear()</button>
                                </li>
                                <li>
                                    <button type="button" class="code-item">(from modules import jump) jump()</button>
                                </li>
                            </ul>
                            <button class="btn-close" type="button">
                                <span class="sr-only">ë‹«ê¸° ë²„íŠ¼</span>
                            </button>
                        </section>
                    </li>
                    <li>
                        <button class="button-before btn-variable btn-toggle" type="button" id="btn-list-variable">
                            <span class="sr-only">ë³€ìˆ˜ ë¦¬ìŠ¤íŠ¸ ë³´ê¸°</span>
                        </button>
                        <section class="controller-modal variable-list">
                            <h4 class="title">ë³€ìˆ˜ ë¦¬ìŠ¤íŠ¸</h4>
                            <ul>
                                <li>
                                    <button type="button" class="code-item">character_data</button>
                                </li>
                                <li>
                                    <button type="button" class="code-item">map_data</button>
                                </li>
                                <li>
                                    <button type="button" class="code-item">item_data</button>
                                </li>
                                <li>
                                    <button type="button" class="code-item">running_speed</button>
                                </li>
                            </ul>
                            <button class="btn-close" type="button">
                                <span class="sr-only">ë‹«ê¸° ë²„íŠ¼</span>
                            </button>
                        </section>
                    </li>
                </ul>
                <ul>
                    <li>
                        <button id="init" class="button-before btn-reset" type="button">
                            <span class="sr-only">ì›”ë“œ, ìºë¦­í„° ì´ˆê¸°í™”</span>
                        </button>
                    </li>
                </ul>
            </nav>
            <section class="world-map">
                <h3 class="sr-only">ìœ„ë‹ˆë¸Œì›”ë“œ ë§µ</h3>
                <div id='app'></div>
            </section>
            <div class="resizer" data-direction="vertical"></div>
            <section class="world-output">
                <h3 class="sr-only">ì‹¤í–‰ ê²°ê³¼</h3>
                <div class="output-wrap">
                    <button id="output-init" class="button-before btn-reset" type="button">
                        <span class="sr-only">result init button</span>
                    </button>
                    <button id="output-download" type="button" class="downloadNotebookBtn btn-file-export">
                            <span class="sr-only">result download</span>
                    </button>
                    <ol class="index-list"></ol>
                    <div id='output' class="output"></div>
                </div>
            </section>
        </section>
        <div class="resizer story-resizer" data-direction="horizontal" data-target="next"></div>
        <section class="story">
            <header class="story-header">
                <h2>ìŠ¤í† ë¦¬ ë³´ê¸°</h2>
                <button type="button" class="btn-write-story">
                    ì§ì ‘ ì‘ì„±í•˜ê¸°
                </button>
                <button type="button" class="btn-close-story">
                    <span class="sr-only">
                        ìŠ¤í† ë¦¬ ë‹«ê¸°
                    </span>
                </button>
            </header>
            <ul class="story-list">
                <li>
                    <section class="story-title">
                        <h3>
                            <span>1í¸</span>ë¼ì´ìº£ì˜ íƒ„ìƒ
                        </h3>
                        <button class="btn-toggle">
                            <span class="sr-only">ìŠ¤í† ë¦¬ ì—¬ë‹«ê¸°</span>
                        </button>
                    </section>
                    <section class="story-contents">
                        <h3 class="sr-only">ìŠ¤í† ë¦¬</h3>
                        <p>
                            ìº£ì€ ë³€ë°©ì—ì„œ ìƒì„  ê°€ê²Œë¥¼ ìš´ì˜í•˜ëŠ” í‰ë²”í•œ ì†Œë…„ì…ë‹ˆë‹¤. ì•„í”ˆ ì–´ë¨¸ë‹ˆë¥¼ ëŒ€ì‹ í•˜ì—¬ ìƒˆë²½ì´ë©´ í—˜í•œ ë°”ë‹¤ì— ë‚˜ê°€ ê³ ê¸°ë¥¼ ì¡ê³ , ì˜¤í›„ê°€ ë˜ë©´ ìƒì„ ì„ íŒŒëŠ” ìƒí™œì„ ë°˜ë³µí•˜ê³  ìˆëŠ”, ì§€ê·¹íˆ í‰ë²”í•œ ì†Œë…„ì´ì£ .
                            í•˜ì§€ë§Œ ì†Œë…„ì€ í•­ìƒ ë…¸ë˜ë¥¼ ë¶€ë¥´ê³ , ì›ƒìœ¼ë©°, ëˆˆê³¼ ê·€ë¥¼ ì—´ì–´ë†“ê³  ì„¸ìƒê³¼ ì‚¬ëŒì— ì§‘ì¤‘í•˜ë©°, ì•„ë¦„ë‹¤ìš´ ê²ƒì— ì‹¬ì·¨í•˜ê³ , ë™í™”ë  ì¤„ ì•Œì•˜ìŠµë‹ˆë‹¤.
                        </p>
                    </section>
                </li>
                <li>
                    <section class="story-title">
                        <h3>
                            <span>2í¸</span>ì—¬í–‰ì„ ë– ë‚œ ë¼ì´ìº£
                        </h3>
                        <button class="btn-toggle">
                            <span class="sr-only">ìŠ¤í† ë¦¬ ì—¬ë‹«ê¸°</span>
                        </button>
                    </section>
                    <section class="story-contents">
                        <h3 class="sr-only">ìŠ¤í† ë¦¬</h3>
                        <p>
                            ì—¬í–‰ì„ ë– ë‚œ ë¼ì´ìº£ ìŠ¤í† ë¦¬
                        </p>
                    </section>
                </li>
            </ul>
        </section>
    </main>
    <p id="pointer"></p>
    <section class="contents hidden">
            <nav class="question-nav">
                <ol>
                    <li><a href="#" id="t1" class="btn-que">T1. ìê²© ì¦ëª…</a></li>
                    <li><a href="#" id="t2" class="btn-que">T2. ì•”í˜¸ë¬¸</a></li>
                </ol>
            </nav>
    </section>
    
    <!-- TODO: ë°°í¬ ì§ì „ì—ëŠ” style="display:none;"ë¥¼ í’€ì–´ì•¼ í•©ë‹ˆë‹¤. -->
    <section class="description" style="display:none;"></section>
    
    <py-script>
        from map import Map
        from wall import Wall
        from character import Character
        from coordinate import character_data, map_data, wall_data, item_data, running_speed, map_size, border_size, wall_type
        from built_in_functions import print, say, directions, show_item, set_item, move, turn_left, pick, put, repeat, attack
        from pyscript import when
        from js import alert, setTimeout
        from pyodide.ffi import create_once_callable
        from pyodide.ffi.wrappers import add_event_listener
        import json
        import math

        # speed slide bar
        slider = js.document.getElementById("speed-range")
        slider_output = js.document.getElementById("speed-text")
        slider_output.innerHTML = slider.value
        running_speed = int(slider.value)/10



        def change_speed(e):
            global running_speed
            slider_output.innerHTML = slider.value
            running_speed = int(slider.value)/10
            if licat:
                licat.set_speed(running_speed)
            else:
                # ì¶”í›„ ë‹¤ë¥¸ ìºë¦­í„° ì¶”ê°€ ì‹œ êµ¬í˜„
                pass

        slider.oninput = change_speed

        # map slide bar
        map_slider_x = js.document.getElementById("map-range-x")
        map_slider_y = js.document.getElementById("map-range-y")
        map_slider_output_x = js.document.getElementById("map-text-x")
        map_slider_output_y = js.document.getElementById("map-text-y")
        map_slider_output_x.innerHTML = map_slider_x.value
        map_slider_output_y.innerHTML = map_slider_y.value
        map_data['height'] = int(map_slider_x.value)
        map_data['width'] = int(map_slider_y.value)
        
        
        
        def change_map(e):
            map_data['height'] = int(map_slider_x.value)
            map_data['width'] = int(map_slider_y.value)
            map_slider_output_x.innerHTML = map_slider_x.value
            map_slider_output_y.innerHTML = map_slider_y.value
            map_exist = js.document.querySelector('.map-container')
            # TODO: map objectëŠ” map_dataì—ì„œ ê´€ë¦¬í•´ì•¼í•  ê²ƒìœ¼ë¡œ ë³´ì„
            if map_exist:
                js.document.querySelector('.map-container').remove()
                map = Map(map_data['height'], map_data['width'])
                draw_map = map.drawMap()
                draw_map.appendChild(draw_character)
                app = Element("app").element
                app.appendChild(draw_map)
            
            draw_map.appendChild(wall.container)

            # ë§µì„ ë²—ì–´ë‚˜ëŠ” ë²½ ì‚­ì œ
            # DOM ìš”ì†Œ ì‚­ì œ
            wall_elements = wall.container.querySelectorAll('.wall')
            wall_width = wall.container.clientWidth - border_size*2 
            wall_height = wall.container.clientHeight- border_size*2 
            for elem in wall_elements:
                top = int(elem.style.top[0:-2])
                left = int(elem.style.left[0:-2])
                if(top >= wall_height or left >=wall_width):
                    wall.container.removeChild(elem)

            # wall_data ìˆ˜ì •
            for type in wall_data:
                for pos in wall_data[type]:
                    x, y = pos
                    if(x > map_data['height']-1 or y > map_data['width']-1):
                        wall_data[type].remove((x, y))

            # ë²”ìœ„ë¥¼ ë²—ì–´ë‚œ ì•„ì´í…œ ì‚­ì œ
            global item_data
            print(f'item_data: {item_data}')
            keys_to_remove = []  # ì œê±°í•  í•­ëª©ì˜ í‚¤ë¥¼ ì €ì¥í•  ë¦¬ìŠ¤íŠ¸

            for (x, y) in item_data.keys():
                if not (0 <= x < map_data['height'] and 0 <= y < map_data['width']):
                    print(f'ğŸ”¥ x: {x}, y: {y}')
                    keys_to_remove.append((x, y))  # ë²”ìœ„ë¥¼ ë²—ì–´ë‚˜ëŠ” í‚¤ë¥¼ ì¶”ê°€
                else:
                    print(f'âœ¨ x: {x}, y: {y}')



            for key in keys_to_remove:
                del item_data[key]  # í‚¤ë¥¼ ì‚¬ìš©í•˜ì—¬ í•­ëª© ì œê±°

            for key, value in item_data.items():
                x, y = int(key[0]), int(key[1])
                name = value['item']
                count = value['count']
                set_item(x, y, name, count)

        map_slider_x.oninput = change_map
        map_slider_y.oninput = change_map

        # character ìƒì„±
        # TODO: ìºë¦­í„° í¬ê¸° ìˆ˜ì •
        licat = Character(x=0, y=0, name='licat', width=32, height=40)
        character_data[0]['character_obj'] = licat
        draw_character = licat.draw()
        
        # map ìƒì„±
        map = Map(map_data['height'], map_data['width'])
        draw_map = map.drawMap()
        draw_map.appendChild(draw_character)

        #ë²½ ìƒì„±
        wall = Wall(wall_data)
        wall.drawWall();
        draw_map.appendChild(wall.container)

        # ìƒì„±ëœ ìš”ì†Œ appì¶”ê°€
        app = Element("app").element
        app.appendChild(draw_map)

        @when("click", selector="#init")
        def init(evt):
            js.console.log('ì›”ë“œ ì´ˆê¸°í™”')
            map_data['height'] = 5
            map_data['width'] = 5
            map_slider_x.value = 5
            map_slider_y.value = 5
            map_slider_output_x.innerHTML = map_slider_x.value
            map_slider_output_y.innerHTML = map_slider_y.value
            map_exist = js.document.querySelector('.map-container')
            # TODO: map objectëŠ” map_dataì—ì„œ ê´€ë¦¬í•´ì•¼í•  ê²ƒìœ¼ë¡œ ë³´ì„
            if map_exist:
                js.document.querySelector('.map-container').remove()
                map = Map(map_data['height'], map_data['width'])
                draw_map = map.drawMap()
                draw_map.appendChild(draw_character)
                app = Element("app").element
                app.appendChild(draw_map)

            # ìƒˆë¡œìš´ ë²½ ë°ì´í„°ë¥¼ ì´ìš©í•˜ì—¬ ë²½ ì´ˆê¸°í™”
            wall.resetWall();
            for key in wall_data:
                wall_data[key] = []
            draw_map.appendChild(wall.container)

            init_character()

        @when("click", selector="#init_character")
        def init_character(evt=None):
            js.console.log('ìºë¦­í„° ì´ˆê¸°í™”')
            js.document.querySelector('.character').remove()
            character_data[0] = {
                'character': 'licat',
                'character_obj': None,
                'x': 0,
                'y': 0,
                'directions': 0, # 0(ë™, ì˜¤ë¥¸ìª½), 1(ë¶), 2(ì„œ, ì™¼ìª½), 3(ë‚¨)
                'items': {}
            }
            licat = Character(x=0, y=0, name='licat', width=32, height=40,rotate=0)
            for line in js.document.querySelectorAll('.line'):
                line.remove()
            character_data[0]['character_obj'] = licat
            draw_character = licat.draw()
            js.document.querySelector('.map-container').appendChild(draw_character)
            add_event_listener(draw_character, 'click', show_character_info)


        @when("click", selector="#btn-list-function")
        def list_function(evt=None):
            '''
            ë©”ì¸í™”ë©´ì—ì„œ í•¨ìˆ˜ ëª©ë¡ ë³´ëŠ” í•¨ìˆ˜
            event.jsì—ì„œ ì²˜ë¦¬í•˜ê³  ìˆì–´ì„œ ì£¼ì„ì²˜ëŸ¬í•˜ì˜€ìŠµë‹ˆë‹¤.
            '''
            # js.console.log('í•¨ìˆ˜ ëª©ë¡')
            # js.document.querySelector('.function-list').classList.# toggle('hidden')

        @when("click", selector="#btn-list-variable")
        def list_variable(evt=None):
            '''
            ë©”ì¸í™”ë©´ì—ì„œ ë³€ìˆ˜ ëª©ë¡ ë³´ëŠ” í•¨ìˆ˜
            event.jsì—ì„œ ì²˜ë¦¬í•˜ê³  ìˆì–´ì„œ ì£¼ì„ì²˜ëŸ¬í•˜ì˜€ìŠµë‹ˆë‹¤.
            '''
            # js.console.log('ë³€ìˆ˜ ëª©ë¡')
            # js.document.querySelector('.variable-list').classList.# # toggle('hidden')

        @when("click", selector=".character")
        def show_character_info(evt=None):
            '''
            ìºë¦­í„°ë¥¼ í´ë¦­í•˜ë©´ ìºë¦­í„° ì •ë³´(character_data)ë¥¼ ë³¼ ìˆ˜ ìˆëŠ” í•¨ìˆ˜ 
            '''
            # evtë¥¼ í†µí•´ xì¢Œí‘œ, yì¢Œí‘œë¥¼ ì–»ì–´ëƒ„
            # x = evt.x
            # y = evt.y
            # xì¢Œí‘œ, yì¢Œí‘œì— ë§í’ì„  ìƒì„±
            bubble = js.document.createElement('div')
            bubble.setAttribute('class', 'character-info-bubble info-modal')
            bubble.style.position = 'absolute'
            bubble.style.left = '47px'
            bubble.style.top = '15px'
            bubble.style.zIndex = '100'
            
            # ë§í’ì„ ì— ìºë¦­í„° ì •ë³´ ì¶”ê°€
            bubble.innerHTML = f'''
                <p class="info-title">ìºë¦­í„° ì •ë³´</p>
                <dl class="info-list">
                    <div class="info-item">
                        <dt class="bubble-body-item-title">ì´ë¦„</dt>
                        <dd class="bubble-body-item-content">{character_data[0]['character']}</dd>
                    </div>
                    <div class="info-item">
                        <dt class="bubble-body-item-title">xì¢Œí‘œ</dt>
                        <dd class="bubble-body-item-content">{character_data[0]['x']}</dd>
                    </div>
                    <div class="info-item">
                        <dt class="bubble-body-item-title">yì¢Œí‘œ</dt>
                        <dd class="bubble-body-item-content">{character_data[0]['y']}</dd>
                    </div>
                    <div class="info-item">
                        <dt class="bubble-body-item-title">ë°©í–¥</dt>
                        <dd class="bubble-body-item-content">{character_data[0]['directions']}</dd>
                    </div>
                    <div class="info-item">
                        <dt class="bubble-body-item-title">ì•„ì´í…œ</dt>
                        <dd class="bubble-body-item-content">{character_data[0]['items']}</dd>
                    </div>
                </dl>
                <button type="button" id="init_character" class="btn-reset">
                    <span class="sr-only">ìºë¦­í„° ì´ˆê¸°í™”</span>
                </button>
            '''
            # appì— ë§í’ì„  ì¶”ê°€(ì´ë¯¸ ë§í’ì„ ì´ ì¡´ì¬í•˜ëŠ” ê²½ìš°ì—ëŠ” ì¶”ê°€í•˜ì§€ ì•ŠìŒ.)
            addedBubble = js.document.querySelector('.character-info-bubble')
            target_character = js.document.querySelector('.character')

            if not addedBubble:
                target_character.appendChild(bubble)

            # 5ì´ˆí›„ ì œê±°
            setTimeout(
                create_once_callable(
                    lambda: (
                        bubble.remove()
                    )
                ), 5000
            )

        @when("click", selector="#btn-download-worlddata")
        def download_worlddata(evt=None):
            '''
            ë©”ì¸í™”ë©´ì—ì„œ ì›”ë“œë°ì´í„° ë‹¤ìš´ë¡œë“œ
            '''
            js.console.log('ì›”ë“œë°ì´í„° ë‹¤ìš´ë¡œë“œ')

            # ì›”ë“œë°ì´í„° ë‹¤ìš´ë¡œë“œ
            character_info = character_data.copy()
            character_info[0]['character_obj'] = None
            worlddata = {
                "character_data": character_info,
                "item_data": item_data,
                "map_data": map_data,
                "wall_data": wall_data
            }
            
            json_data = json.dumps(worlddata)
            file = js.File.new([json_data], "unused_file_name.txt", {type: "text/plain"})
            url = js.URL.createObjectURL(file)
            hidden_link = js.document.createElement("a")
            hidden_link.setAttribute("download", "my_other_file_name.txt")
            hidden_link.setAttribute("href", url)
            hidden_link.click()

        @when("click", selector="#btn-upload-worlddata")
        def upload_worlddata(evt=None):
            '''
            ë©”ì¸í™”ë©´ì—ì„œ ì›”ë“œë°ì´í„° ì—…ë¡œë“œ
            '''
            js.console.log('ì›”ë“œë°ì´í„° ì—…ë¡œë“œ')
        

        @when("click", selector=".wall-container")
        def edit_wall(evt):
            '''
            ë§µì— ë²½ ì¶”ê°€
            '''
            if(evt.target == evt.currentTarget):
                if(wall_type=='delete'):
                    return
                x = conver_position(evt.offsetY)
                y = conver_position(evt.offsetX)

                # í…Œë‘ë¦¬ ì‚­ì œ
                if( x < 0 or x > map_data['height'] - 1 or y < 0 or y > map_data['width']-1):
                    return
            
                # xëŠ” ì •ìˆ˜ì´ê³ , yëŠ” ì‹¤ìˆ˜ì¸ ê²½ìš°
                if(isinstance(x, int) and isinstance(y, float)) or (isinstance(x, float) and isinstance(y, int)):
                    wall_data[wall_type].append((x, y))
                    wall.addWall(wall_type,(x, y))
        
            else: # ì‚­ì œ
                if(wall_type=='delete'):
                    delete_wall(evt.target)
            
            

        def delete_wall(wall):
            '''
            ë²½ ì‚­ì œ
            '''
            wall.parentNode.removeChild(wall)
            
            if(wall.dataset.direction=='portrait'):
                x, y = _get_position(wall.style.top, wall.style.left, 'portrait')
                type = wall.dataset.type
                wall_data[type].remove((x, y))
            else:  
                x, y = _get_position(wall.style.top, wall.style.left, 'landscape')
                type = wall.dataset.type
                wall_data[type].remove((x, y))


        @when("mousemove", selector=".wall-container")
        def mouse_on(evt):
            '''
            ë§µì´ ë²½ì„ ì¶”ê°€í•  ìˆ˜ ìˆëŠ” ìƒíƒœì¸ì§€ í™•ì¸í•˜ì—¬ ë§ˆìš°ìŠ¤ ìƒíƒœ ë³€ê²½
            '''
            if(evt.target == evt.currentTarget and wall_type!='delete'):
                wall_container = js.document.querySelector('.wall-container')
                
                x = conver_position(evt.offsetY)
                y = conver_position(evt.offsetX)

                # í…Œë‘ë¦¬ ì‚­ì œ
                if( x < 0 or x > map_data['height'] - 1 or y < 0 or y > map_data['width']-1):
                    return

                if(isinstance(x, int) and isinstance(y, float)) or (isinstance(x, float) and isinstance(y, int)):
                    wall_container.style.cursor="pointer";
                else:
                    wall_container.style.cursor="auto";

        # wall_typeì´ deleteì¼ ë•Œ, ë§ˆìš°ìŠ¤ ì˜¤ë²„ ì‹œ ì•¡í‹°ë¸Œ
        @when("mouseover", selector=".wall-container")
        def over_wall(evt):
            if(evt.target.classList.value=='wall' and wall_type=='delete'):
                evt.target.style.outline='2px solid red'   
                evt.target.style.cursor='pointer'
        
        @when("mouseout", selector=".wall-container")
        def out_wall(evt):
            if(evt.target.classList.value=='wall' and wall_type=='delete'):
                evt.target.style.outline=''   
        
        # offset ê°’ì„ ì…ë ¥í–ˆì„ ë•Œ, ì¢Œí‘œê³„ ê°’ìœ¼ë¡œ ë³€í™˜
        def conver_position(x):
            box_size =  map_size + border_size*2 
            n = int(x/box_size)
            if n*box_size+1 < x < (n+1)*box_size-1:
                return n
            else: 
                return _get_integer(x/box_size)-0.5
        
        # ê°€ì¥ ê°€ê¹Œìš´ ì •ìˆ˜ ë°˜í™˜
        def _get_integer(num):
            integer = int(num + 0.5) if num >= 0 else int(num - 0.5)
            return integer

        # wall css ìœ„ì¹˜ê°’(top, left)ë¡œ ì¢Œí‘œê°’ ë°˜í™˜
        def _get_position(top,left, type):
            # px í…ìŠ¤íŠ¸ ê°’ì„ ì‹¤ìˆ˜ë¡œ ë³€ê²½
            top = float(top[:-2])
            left = float(left[:-2])
            
            box_size = map_size+border_size*2
            if (type=='portrait'):
                return top/box_size - 0.5, left/box_size-0.5
            else: # landscape
                return top/box_size, (left+border_size)/box_size-0.5


        # radio ì†ì„±ì„ ì„ íƒí–ˆì„ ë•Œ, wall_typeì„ ë³€ê²½í•˜ëŠ” ì´ë²¤íŠ¸ ë“±ë¡
        @when("change", selector="input[name='wall-type']")
        def change_wall_type(evt):
            global wall_type
            wall_type = evt.target.value

        @when("click", selector="#output-init")
        def init_output(evt=None):
            for output_line in js.document.querySelectorAll('.output-item'):
                output_line.remove()
            for liElement in js.document.querySelectorAll('.index-list li'):
                liElement.remove()

        @when("click", selector="#output-download")
        def init_output(evt=None):
            ''''
            js.document.querySelectorAll('.output-item')ì— ìˆëŠ” ëª¨ë“  ë‚´ìš©ì„
            txt íŒŒì¼ë¡œ ë‹¤ìš´ë¡œë“œ í•˜ëŠ” ì½”ë“œ
            '''
            js.console.log('ë‹¤ìš´ë¡œë“œ')
            output = js.document.querySelectorAll('.output-item')
            output_text = ''
            for line in output:
                output_text += line.innerHTML + '\n'
            file = js.File.new([output_text], "result.txt", {type: "text/plain"})
            url = js.URL.createObjectURL(file)
            hidden_link = js.document.createElement("a")
            hidden_link.setAttribute("download", "result.txt")
            hidden_link.setAttribute("href", url)
            hidden_link.click()


    
    </py-script>
    <script>
    const downloadBtn = document.querySelector('.downloadNotebookBtn')
    downloadBtn.addEventListener('click', () => {
        downloadNotebook()
    })
    function downloadNotebook() {
        const notebook = {
            "cells": [],
            "metadata": {
                "kernelspec": {
                    "display_name": "Python 3",
                    "language": "python",
                    "name": "python3"
                },
                "language_info": {
                    "codemirror_mode": {
                        "name": "ipython",
                        "version": 3
                    },
                    "file_extension": ".py",
                    "mimetype": "text/x-python",
                    "name": "python",
                    "nbconvert_exporter": "python",
                    "pygments_lexer": "ipython3",
                    "version": "3.7.9"
                }
            },
            "nbformat": 4,
            "nbformat_minor": 4
        };

        const cells = document.querySelectorAll('.py-repl-editor')

        for (let i = 0; i < cells.length; i++) {
            cells
            notebook.cells.push({
                "cell_type": "code",
                "execution_count": null,
                "metadata": {},
                "outputs": [],
                "source": cells[i].childNodes[0].shadowRoot.querySelector('.cm-content').innerText
            });
        }

        const notebookJson = JSON.stringify(notebook, null, 2);
        const blob = new Blob([notebookJson], { type: 'application/json' });
        const url = URL.createObjectURL(blob);

        const a = document.createElement('a');
        a.download = 'notebook.ipynb';
        a.href = url;
        a.click();
    }
    </script>
</body>
</html>